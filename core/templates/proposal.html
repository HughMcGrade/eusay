{% extends "base.html" %}
{% load static %}
{% load filters %}

{% block title %}
{% if not hide %}
| {{ proposal.title }}
{% else %}
| Hidden proposal
{% endif %}
{% endblock %}

{% block js %}
<script src="{% static "js/jquery.form.js" %}"></script>
<script src="{% static "js/jquery.cookie.js" %}"></script>
<script>

 function hideReplyForms() {
   // hide comment reply forms
   $(".comment-reply-form").hide({
     duration: 0
   });
 }

 function putNewMessages(response) {
   var html = $.parseHTML(response);
   var selector = '#message_container';
   var messages = $(html).find(selector).children();
   if (messages.length != 0) {
     // New messages
     $(selector).html(messages);
     $('html').animate({scrollTop:0}, 'slow');
   }
 }

 function initForms() {
   $('.proposal-comment-form').ajaxForm(
     { clearForm : true,
      beforeSend: function() {
	$('.submit-comment-button').attr('disabled', true);
	$('.submit-comment-button').text('Submitting...');
      },
      success: function(response, statusText, xhr) {
	$('.submit-comment-button').attr('disabled', false);
	$('.submit-comment-button').text('Submit');
	if (xhr.getResponseHeader('Comment-Id') != null) {
          // Reply posted
	  var html = $.parseHTML(response);
          var selector = '#comment_replies_' + xhr.getResponseHeader("Comment-Id");
          var comment = $(html).find(selector).children();
	  $(selector).html(comment);
	}
	else {
	  var html = $.parseHTML(response);
	  var selector = '#proposal_comments';
	  var comments = $(html).find(selector).children();
	  if (comments.length != 0) {
	    $(selector).html(comments);
	  }
	}
	initForms();
	hideReplyForms();
	putNewMessages(response);
      }
     });
   $('#proposal_vote_form').ajaxForm(
     { beforeSend: function() {
       $('.proposal-vote-button').attr('disabled', true);
       },
       success: function(response, statusText, xhr) {
	 $('.proposal-vote-button').attr('disabled', false);
	 var html = $.parseHTML(response);
	 var votes = $(html).find('#proposal_vote_div').children();
	 if (votes.length != 0) {
	   $('#proposal_vote_div').html(votes);
	 }
	 initForms();

	 // Reload progress bar
	 var progressBar = $(html).find('#proposal_progress_bar').children();
	 if (progressBar.length != 0) {
	   $('#proposal_progress_bar').html(progressBar);
	 }

	 // Reload messages
	 putNewMessages(response);
       }
     });
   $('.comment_vote_form').ajaxForm(
     {beforeSend: function() {
       	 $('.comment-vote-button').attr('disabled', true);
      },
      success: function(response, statusText, xhr) {
       	$('.comment-vote-button').attr('disabled', false);
	var html = $.parseHTML(response);
	var selector = '#comment_' + xhr.getResponseHeader("Comment-Id");
	var comment = $(html).find(selector).children();
	if (comment.length != 0) {
	  $(selector).html(comment);
	}
	initForms();
	putNewMessages(response);
     }});
 };
 $(document).ready(function() {
   initForms();
   // find similar proposals
   $.getJSON("{% url "api_v1:similarproposals" proposal.id %}", function(data) {
     var output = "<ul>";
     for (var i in data.results) {
       output += "<li><a href='/proposal/" + data.results[i].id + "' class='alert-link'>" +  data.results[i].title + "</a> " + data.results[i].votesUp + " votes in favor</li>";
     }
     output += "</ul>";
     if (data.count > 0) {
       $("#similarList").html(output);
       $("#similar").fadeIn();
     }
   });

   hideReplyForms();
 });

 function showReplyForm(id) {
   $("#comment-reply-form-box-" + id).slideToggle("fast", function() {
     $("#comment-reply-form-" + id +  "> textarea").focus()
   });
 };
 function viewHiddenProposal() {
   $("#view-hidden-proposal-button").slideUp(function() {
     $(".proposal-hidden").slideDown()
   });
 }
</script>

{% endblock %}

{% block progressbar %}
{% endblock %}

{% block content %}
{% if hide %}
<div class="row">
  <div class="col-xs-12 col-md-8 col-md-offset-2">
    <div class="panel panel-danger">
      <div class="panel-heading">Careful now</div>
      <div class="panel-body">
        <p>This proposal has been hidden. You can still view it, but it may not abide by EUSA safe space policy!</p>
        <p><strong>Reason:</strong> {{ hide.reason }}</p>
        <button type="button" class="btn btn-danger" id="view-hidden-proposal-button" onclick="viewHiddenProposal()">View anyway</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="row">
  <div class="col-xs-12 col-md-8 col-md-offset-2">
    <div class="proposal-page page-shadow{% if hide %} proposal-hidden{% endif %}">

      <div class="row">
        <div class="col-xs-12">
          <h2 id="proposal-title" class="text-center">{{ proposal.title }}</h2>
          <p class="text-center">
            {% if proposal.get_status_display == "Open for discussion" %}
              <span data-toggle="tooltip" title="EUSA has not yet responded to this proposal."><span class="glyphicon glyphicon-play-circle"></span> {{ proposal.get_status_display }}</span>
            {% elif proposal.get_status_display == "Work in progress" %}
              <span data-toggle="tooltip" title="EUSA is working on this proposal."><span class="glyphicon glyphicon-time"></span> {{ proposal.get_status_display }}</span>
            {% elif proposal.get_status_display == "Going to Student Council" %}
              <span class="green"><span class="glyphicon glyphicon-time"></span> {{ proposal.get_status_display }} on {{ proposal.student_council }}</span>
            {% elif proposal.get_status_display == "Resolved" %}
              <a class="green" href="#proposal-response"><span class="glyphicon glyphicon-ok-circle"></span> {{ proposal.get_status_display }} â–¾</a>
            {% endif %}

            <br />

            <span id="proposal-user">by
            {% if proposal.user.hasProfile %}
                <a href="{% url 'user' proposal.user.slug %}">{{ proposal.user.username }}</a>
            {% else %}
                {{ proposal.user.username }}
            {% endif %}
            </span>
          </p>
        </div>
      </div>
      <div id="proposal_progress_bar" class="progress proposal-progress-bar">
        <div class="progress-bar progress-bar-success proposal-progress-bar-up" data-toggle="tooltip" title="{{ proposal.upVotes }} vote{{ proposal.upVotes|pluralize }} in favor" style="width: {{ proposal.get_votes_up_percentage }}%">
        </div>
        <div class="progress-bar progress-bar-danger proposal-progress-bar-down" data-toggle="tooltip" title="{{ proposal.downVotes }} vote{{ proposal.downVotes|pluralize }} against" style="width: {{ proposal.get_votes_down_percentage }}%">
        </div>
      </div>
      <div class="row proposal-text">
        <div class="col-xs-10 col-xs-offset-1">
          {{ proposal.text | my_markdown }}
        </div>
      </div>

          {% if proposal.response %}
          <div class="row">
            <div class="col-xs-10 col-xs-offset-1">
              <div class="well" id="proposal-response">
                <h4 class="text-center">
                  <span class="glyphicon glyphicon-star comment-user-status"></span>
                  {{ proposal.response.user.username }} ({{ proposal.response.user.get_userStatus_display }}) responded to this proposal:
                </h4>
                <p>{{ proposal.response.text }}</p>
                <span class="text-muted">{{ proposal.response.createdAt | date:"j M Y, f a" }}</span>
              </div>
            </div>
          </div>
        {% endif %}

      <hr id="proposal-vote-form-top" class="fancy-hr" />

      <form id="proposal_vote_form" method="post">
        <input type="hidden" name="request" value="proposal_vote" />
        {% csrf_token %}
        <div id="proposal_vote_div" class="row proposal-vote-buttons">
          <div class="col-md-3 col-md-offset-2 col-xs-6">
            <button name="vote" value="up" type="submit" class="proposal-vote-button btn btn-lg btn-block {% if user_vote == -1 %} btn-default {% else %} btn-success {% endif %}"><span class="glyphicon glyphicon-thumbs-up"></span> Agree</button>
          </div>
          <div class="col-md-3 col-md-offset-2 col-xs-6">
            <button name="vote" value="down" type="submit" class="proposal-vote-button btn btn-lg btn-block {% if user_vote == 1 %} btn-default {% else %} btn-danger {% endif %}"><span class="glyphicon glyphicon-thumbs-down"></span> Disagree</button>
          </div>
        </div>
      </form>

      {% if proposal.tags.all %}
      <div class="row proposal-tags">
        <div class="col-xs-12">
          <p>Tags:<br />
            {% for tag in proposal.tags.all %}<a class="tag" href="{% url 'tag' tag.id tag.slug %}">{{ tag.name }}</a>{% endfor %}</p>
        </div>
      </div>
      {% endif %}

      <div class="row proposal-metainfo">
        <div class="col-xs-6">
          <span class="text-muted">{{ proposal.createdAt | date:"j M Y, f a" }}</span>
        </div>
        <div class="col-xs-12 btn-toolbar">
          {% if not hide %}
          <div class="btn-group">
            {% if user.isModerator and not hide %}
            <a type="button" class="btn btn-default btn-xs" href="{% url 'hide_proposal' proposal.id %}">Hide</a>
            {% else %}
            <a type="button" class="btn btn-default btn-xs" href="{% url 'report_proposal' proposal.id %}">Report</a>
            {% endif %}
            <a type="button" class="btn btn-default btn-xs" href="{% url 'amend_proposal' proposal.id %}">Propose Amendment</a>
            {% if user.userStatus == "Staff" or user.userStatus == "Officeholder" %}
            <a type="button" class="btn btn-default btn-xs" href="{% url 'update_proposal_status' proposal.id %}">Update proposal status</a>
            <a type="button" class="btn btn-default btn-xs" href="{% url 'respond' proposal.id proposal.slug %}">Write official response</a>
            {% endif %}
            {% if proposal.user = user %}
            <a type="button" class="btn btn-default btn-xs" href="{% url 'delete_proposal' proposal.id %}">Delete</a>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div> <!-- /.proposal-page -->
  </div> <!-- /.col -->
</div> <!-- /.row -->

<div class="comments{% if hide %} proposal-hidden{% endif %}">
  {% include "proposal_comments.html" %}
</div>

<!--<div class="row" id="similar">
<div class="col-xs-12">
<h3>Similar proposals:</h3>
<div id="similarList">
</div>
</div>
</div>-->

{% endblock %}
